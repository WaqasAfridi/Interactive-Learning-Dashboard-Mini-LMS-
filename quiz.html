<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EduPro - Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-gray-100 text-gray-800 font-sans flex flex-col min-h-screen">
    <nav class="bg-white shadow-md w-full">
      <div
        class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between"
      >
        <a href="index.html" class="text-2xl font-bold text-blue-600">EduPro</a>
        <a href="dashboard.html" class="text-gray-600 hover:text-black"
          >Exit Quiz</a
        >
      </div>
    </nav>

    <div class="flex-grow flex items-center justify-center p-4">
      <div
        class="bg-white p-8 rounded-xl shadow-lg max-w-2xl w-full"
        id="quiz-container"
      ></div>
    </div>

    <script src="data.js"></script>
    <script src="script.js"></script>
    <script>
      // Prevent unauthenticated access (must run after script.js is loaded)
      if (!getCurrentUser()) {
        alert("You must be logged in to view this page.");
        window.location.href = "login.html";
      }

      const params = new URLSearchParams(window.location.search);
      const cId = parseInt(params.get("courseId"));
      const container = document.getElementById("quiz-container");

      let course = null;
      let quizData = null;
      let currentQ = 0;
      let score = 0;
      let isLocked = false; // Add state to prevent multiple clicks

      // REMOVED: const PASS_SCORE = 3; (Already defined in script.js)

      setTimeout(() => {
        course = coursesData.find((c) => c.id === cId);

        if (!course) {
          container.innerHTML = `<div class="p-8 text-center text-red-500 font-bold">Error: Course not found.</div>`;
          return;
        }

        quizData = course.quiz;
        const progress = getProgress(cId);

        // --- ENFORCEMENT: Check Lesson Completion ---
        if (progress.completedLessons.length !== course.lessons.length) {
          showRequirementError(course.title, course.lessons.length);
          return;
        }

        // Check if quiz already completed
        if (progress.quizScore !== null) {
          showPreviousResult(
            progress.quizScore,
            progress.quizScore >= PASS_SCORE
          );
          return;
        }

        // Initialize quiz
        renderQuestion();
      }, 100);

      // --- New Helper Functions ---

      function showRequirementError(courseTitle, totalLessons) {
        container.innerHTML = `
              <div class="text-center py-8">
                  <i class="fas fa-lock text-5xl text-red-500 mb-4"></i>
                  <h2 class="text-3xl font-bold mb-2 text-gray-900">Quiz Locked</h2>
                  <p class="text-lg text-gray-600 mb-6">You must complete all lessons in **${courseTitle}** before starting the final quiz.</p>
                  <p class="text-sm text-gray-500 mb-8">Current Lessons Completed: ${
                    getProgress(cId).completedLessons.length
                  } / ${totalLessons}</p>
                  <a href="course-detail.html?id=${cId}" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 transition shadow">
                      Return to Course Lessons
                  </a>
              </div>
          `;
      }

      function showPreviousResult(currentScore, passed) {
        container.innerHTML = `
              <div class="text-center py-8">
                  <div class="inline-block p-4 rounded-full ${
                    passed
                      ? "bg-green-100 text-green-600"
                      : "bg-red-100 text-red-600"
                  } mb-4">
                      <i class="fas ${
                        passed ? "fa-trophy" : "fa-undo"
                      } text-5xl"></i>
                  </div>
                  <h2 class="text-3xl font-bold mb-2 text-gray-900">${
                    passed ? "Quiz Already Passed!" : "Quiz Score Recorded"
                  }</h2>
                  <p class="text-lg text-gray-600 mb-8">Your previous score: <span class="font-bold text-black">${currentScore}</span> out of ${
          quizData.length
        }</p>
                  
                  <div class="flex justify-center gap-4">
                      <a href="dashboard.html" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 transition shadow">Go to Dashboard</a>
                      ${
                        !passed
                          ? `<button onclick="location.reload()" class="bg-gray-800 text-white px-6 py-3 rounded-lg font-bold hover:bg-gray-900 transition shadow">Retry Quiz</button>`
                          : ""
                      }
                  </div>
              </div>
          `;
      }

      // --- Core Quiz Logic (Render, Handle Answer, Show Result) ---

      function renderQuestion() {
        isLocked = false; // Unlock for the new question
        if (currentQ >= quizData.length) {
          showResult();
          return;
        }

        const q = quizData[currentQ];
        container.innerHTML = `
        <div class="flex justify-between items-center mb-6">
          <span class="text-gray-500 font-bold text-sm uppercase tracking-wide">Question ${
            currentQ + 1
          } of ${quizData.length}</span>
          <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">Score: ${score}</span>
        </div>
        <h2 class="text-2xl font-bold mb-8 text-gray-800">${q.q}</h2>
        <div class="space-y-4" id="options-container">
          ${q.options
            .map(
              (opt, idx) => `
            <button id="option-${idx}" data-index="${idx}" onclick="handleAnswerClick(this, ${idx})" class="w-full text-left p-4 border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition duration-200 font-medium text-gray-700">
              ${opt}
            </button>
          `
            )
            .join("")}
        </div>
      `;
      }

      function handleAnswerClick(buttonElement, selectedIdx) {
        if (isLocked) return;
        isLocked = true; // Lock controls

        const currentQuestion = quizData[currentQ];
        const correctIdx = currentQuestion.correct;
        const isCorrect = selectedIdx === correctIdx;

        // 1. Provide visual feedback
        if (isCorrect) {
          score++; // Update score immediately for display
          buttonElement.classList.remove(
            "border-gray-200",
            "hover:border-blue-500",
            "hover:bg-blue-50"
          );
          buttonElement.classList.add(
            "bg-green-100",
            "border-green-500",
            "text-green-800",
            "font-bold"
          );
        } else {
          buttonElement.classList.remove(
            "border-gray-200",
            "hover:border-blue-500",
            "hover:bg-blue-50"
          );
          buttonElement.classList.add(
            "bg-red-100",
            "border-red-500",
            "text-red-800",
            "font-bold"
          );
          // Highlight correct answer
          const correctButton = document.getElementById(`option-${correctIdx}`);
          correctButton.classList.remove("border-gray-200");
          correctButton.classList.add(
            "bg-green-200",
            "border-green-600",
            "text-green-900"
          );
        }

        // Disable all buttons after choice
        document
          .getElementById("options-container")
          .querySelectorAll("button")
          .forEach((btn) => (btn.disabled = true));

        // 2. Move to next question after a delay
        setTimeout(() => {
          currentQ++;
          renderQuestion();
        }, 1500); // Wait 1.5 seconds for the user to see the feedback
      }

      function showResult() {
        const passed = score >= PASS_SCORE;
        saveQuizScore(cId, score);

        container.innerHTML = `
                <div class="text-center py-8">
                    <div class="inline-block p-4 rounded-full ${
                      passed
                        ? "bg-green-100 text-green-600"
                        : "bg-red-100 text-red-600"
                    } mb-4">
                        <i class="fas ${
                          passed ? "fa-trophy" : "fa-times-circle"
                        } text-5xl"></i>
                    </div>
                    <h2 class="text-3xl font-bold mb-2 text-gray-900">${
                      passed ? "Congratulations, You Passed!" : "Quiz Failed"
                    }</h2>
                    <p class="text-lg text-gray-600 mb-8">You scored <span class="font-bold text-black">${score}</span> out of ${
          quizData.length
        }. You needed ${PASS_SCORE} to pass.</p>
                    
                    <div class="flex justify-center gap-4">
                        ${
                          passed
                            ? `<a href="dashboard.html" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 transition shadow">Go to Dashboard</a>`
                            : `<button onclick="location.reload()" class="bg-gray-800 text-white px-6 py-3 rounded-lg font-bold hover:bg-gray-900 transition shadow">Retry Quiz</button>`
                        }
                    </div>
                </div>
            `;
      }
    </script>
  </body>
</html>
