<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EduPro - Course Details</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-gray-50 text-gray-800 font-sans flex flex-col min-h-screen">
    <nav class="bg-white shadow-md fixed w-full z-50 top-0 left-0">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
          <div class="flex items-center">
            <a href="index.html" class="text-2xl font-bold text-blue-600"
              ><i class="fas fa-graduation-cap"></i> EduPro</a
            >
          </div>
          <div class="hidden md:flex items-center space-x-8">
            <a href="index.html" class="text-gray-600 hover:text-blue-600"
              >Home</a
            >
            <a href="courses.html" class="text-blue-600 font-semibold"
              >Courses</a
            >
            <a
              href="dashboard.html"
              class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700"
              >Dashboard</a
            >
          </div>
          <div class="md:hidden flex items-center">
            <button
              id="mobile-menu-btn"
              class="text-gray-600 hover:text-blue-600 focus:outline-none"
            >
              <i class="fas fa-bars text-2xl"></i>
            </button>
          </div>
        </div>
      </div>
      <div
        id="mobile-menu"
        class="hidden md:hidden bg-white pb-4 px-4 border-t"
      >
        <a href="index.html" class="block py-2 text-gray-600">Home</a>
        <a href="courses.html" class="block py-2 text-blue-600 font-bold"
          >Courses</a
        >
        <a href="dashboard.html" class="block py-2 text-gray-600">Dashboard</a>
      </div>
    </nav>

    <div
      class="pt-24 pb-12 max-w-7xl mx-auto px-4 flex-grow"
      id="course-detail-container"
    >
      <div class="bg-white p-8 rounded-xl shadow-lg text-center text-gray-500">
        Loading course details...
      </div>
    </div>

    <footer class="bg-gray-800 text-white py-8 text-center mt-auto">
      <p>&copy; 2025 EduPro LMS. All rights reserved.</p>
    </footer>

    <script src="data.js"></script>
    <script src="script.js"></script>
    <script>
      const params = new URLSearchParams(window.location.search);
      const cId = parseInt(params.get("id"));
      const container = document.getElementById("course-detail-container");
      const currentUser = getCurrentUser(); // Get user info

      // Define course variable globally
      const course = coursesData.find((c) => c.id === cId);

      // --- Start Immediate Rendering Logic ---

      if (!course) {
        container.innerHTML = `
            <div class="bg-white p-8 rounded-xl shadow-lg text-center text-red-500">
                Course not found (ID: ${cId}).
            </div>`;
      } else {
        // Retrieve progress data
        const progress = getProgress(cId);

        // Check enrollment status
        const isEnrolled =
          progress.completedLessons.length > 0 || progress.quizScore !== null;

        const totalLessons = course.lessons.length;
        const lessonsCompleted = progress.completedLessons.length;
        const progressPercent = calculateCourseProgress(cId);

        let nextLessonId =
          lessonsCompleted > 0 && lessonsCompleted < totalLessons
            ? course.lessons[lessonsCompleted].id
            : course.lessons[0].id;

        const isCourseComplete = progressPercent === 100;
        const quizPassed =
          progress.quizScore !== null &&
          progress.quizScore >=
            (typeof PASS_SCORE !== "undefined" ? PASS_SCORE : 3);
        const isCertified = isCourseComplete && quizPassed;

        // --- Dynamic Button Logic ---
        let actionButtonHTML = "";

        if (isCertified) {
          actionButtonHTML = `
                <div class="flex items-center gap-2">
                    <span class="text-green-600 font-bold mr-2"><i class="fas fa-check-circle"></i> Certified!</span>
                    <button onclick="viewCertificate(${cId})" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 transition">View Certificate</button>
                </div>
            `;
        } else if (
          lessonsCompleted === totalLessons &&
          course.quiz &&
          course.quiz.length > 0 &&
          progress.quizScore === null
        ) {
          actionButtonHTML = `
                <a href="quiz.html?courseId=${cId}" class="bg-orange-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-orange-700 transition">Take Final Quiz (${course.quiz.length} Qs)</a>
            `;
        } else if (isEnrolled) {
          actionButtonHTML = `
                <a href="lesson.html?courseId=${cId}&lessonId=${nextLessonId}" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 transition">
                    <i class="fas fa-play-circle mr-2"></i> ${
                      lessonsCompleted > 0 ? "Continue Course" : "Start Course"
                    }
                </a>
            `;
        } else {
          // Not enrolled
          actionButtonHTML = `
                <button onclick="enrollAndStart(${cId})" class="bg-green-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-green-700 transition">
                    <i class="fas fa-user-plus mr-2"></i> Enroll Now (Free)
                </button>
            `;
        }

        // --- Render Course Details ---
        container.innerHTML = `
            <div class="bg-white rounded-xl shadow-xl overflow-hidden">
                <div class="md:flex">
                    <div class="md:flex-shrink-0">
                        <img class="h-64 w-full object-cover md:w-64" src="${
                          course.image
                        }" alt="${course.title}">
                    </div>
                    <div class="p-8 flex-1">
                        <div class="uppercase tracking-wide text-sm text-blue-600 font-bold">${
                          course.category
                        }</div>
                        <h1 class="block mt-1 text-4xl leading-tight font-extrabold text-gray-900">${
                          course.title
                        }</h1>
                        <p class="mt-2 text-gray-500 text-lg">${
                          course.description
                        }</p>
                        
                        <div class="mt-4 flex items-center space-x-6 text-gray-600">
                            <span><i class="fas fa-clock mr-1"></i> ${
                              course.duration || "N/A"
                            }</span>
                            <span><i class="fas fa-list-ul mr-1"></i> ${
                              course.lessons.length
                            } Lessons</span>
                            <span><i class="fas fa-star text-yellow-500 mr-1"></i> ${
                              course.rating ? course.rating.toFixed(1) : "5.0"
                            } (${course.reviews || 0} reviews)</span>
                        </div>
                    </div>
                </div>
                
                ${
                  isEnrolled
                    ? `
                <div class="bg-blue-50 p-6 border-t">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold text-blue-700">Course Progress</span>
                        <span class="font-bold text-blue-800">${progressPercent}%</span>
                    </div>
                    <div class="w-full bg-blue-200 rounded-full h-3">
                        <div class="bg-blue-600 h-3 rounded-full transition-all duration-500" style="width: ${progressPercent}%"></div>
                    </div>
                    ${
                      quizPassed
                        ? '<p class="text-sm text-green-600 mt-2 font-medium"><i class="fas fa-medal"></i> Quiz Passed!</p>'
                        : progress.quizScore !== null
                        ? '<p class="text-sm text-red-600 mt-2 font-medium"><i class="fas fa-times-circle"></i> Quiz Failed. Retry possible.</p>'
                        : ""
                    }
                </div>`
                    : ""
                }

                <div class="p-6 border-t flex justify-end">
                    ${actionButtonHTML}
                </div>

                <div class="p-8 border-t">
                    <h2 class="text-2xl font-bold mb-4">Curriculum (${totalLessons} Lessons)</h2>
                    <div class="space-y-3">
                        ${course.lessons
                          .map((lesson, index) => {
                            const isDone = progress.completedLessons.includes(
                              lesson.id
                            );
                            const isNext =
                              isEnrolled &&
                              !isDone &&
                              lessonsCompleted === index;
                            return `
                                <a href="lesson.html?courseId=${cId}&lessonId=${
                              lesson.id
                            }" class="flex items-center p-4 bg-gray-50 rounded-lg shadow-sm hover:shadow transition ${
                              isDone
                                ? "border-l-4 border-green-500"
                                : isNext
                                ? "border-l-4 border-blue-500"
                                : "border border-gray-200"
                            }">
                                    <i class="fas ${
                                      isDone
                                        ? "fa-check-circle text-green-500"
                                        : "fa-circle text-gray-400"
                                    } mr-4 text-xl"></i>
                                    <div class="flex-1"><h3 class="font-semibold text-gray-800">${
                                      lesson.title
                                    }</h3></div>
                                    ${
                                      isNext
                                        ? '<span class="text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded-full font-bold">NEXT</span>'
                                        : ""
                                    }
                                </a>`;
                          })
                          .join("")}
                        
                        <div class="flex items-center p-4 rounded-lg border-2 ${
                          progress.quizScore !== null
                            ? quizPassed
                              ? "border-green-500 bg-green-50"
                              : "border-red-500 bg-red-50"
                            : lessonsCompleted === totalLessons
                            ? "border-orange-500 bg-orange-50"
                            : "border-gray-200 bg-gray-50"
                        }">
                            <i class="fas fa-question-circle ${
                              progress.quizScore !== null
                                ? quizPassed
                                  ? "text-green-500"
                                  : "text-red-500"
                                : "text-orange-500"
                            } mr-4 text-xl"></i>
                            <div class="flex-1"><h3 class="font-semibold text-gray-800">Final Course Quiz (${
                              course.quiz.length
                            } Questions)</h3></div>
                            ${
                              progress.quizScore !== null
                                ? `<span class="font-bold ${
                                    quizPassed
                                      ? "text-green-700"
                                      : "text-red-700"
                                  }">${quizPassed ? "PASSED" : "FAILED"} (${
                                    progress.quizScore
                                  }/5)</span>`
                                : lessonsCompleted === totalLessons
                                ? `<a href="quiz.html?courseId=${cId}" class="text-blue-600 hover:underline font-bold">Start Quiz</a>`
                                : `<span class="text-gray-500 text-sm">Requires all lessons completed</span>`
                            }
                        </div>
                    </div>
                </div>
            </div>
        `;
      }

      // --- Action Functions ---

      window.enrollAndStart = function (courseId) {
        // AUTH CHECK: Force login if guest
        if (!getCurrentUser()) {
          alert("You must be logged in to enroll.");
          window.location.href = "login.html";
          return;
        }

        if (!course || course.lessons.length === 0) {
          alert("Cannot enroll: Course data missing or empty.");
          return;
        }

        // Ensure the enrolled flag is set
        enrollInCourse(courseId);

        // You had previously auto-completed the first lesson when enrolling.
        // Keep that behavior (if desired) â€” this makes sure the user is enrolled AND the first lesson is marked.
        const firstLessonId = course.lessons[0].id;
        completeLesson(courseId, firstLessonId);

        window.location.href = `lesson.html?courseId=${courseId}&lessonId=${firstLessonId}`;
      };

      window.viewCertificate = function (courseId) {
        const modal = document.getElementById("certificate-modal");
        const courseData = coursesData.find((c) => c.id === courseId);
        const pData = getProgress(courseId);
        const user = getCurrentUser(); // Get real user

        if (!courseData || !pData || !user) {
          alert("Error loading certificate data.");
          return;
        }

        // Populate certificate details
        document.getElementById("cert-course-title").innerText =
          courseData.title;
        document.getElementById("cert-date").innerText =
          new Date().toLocaleDateString("en-US", {
            year: "numeric",
            month: "long",
            day: "numeric",
          });
        document.getElementById(
          "cert-score"
        ).innerText = `${pData.quizScore}/${courseData.quiz.length}`;

        // --- NEW: Insert User Name ---
        // Find the element for student name (h2 with class text-green-600) and update it
        const nameElement = document.querySelector(
          "#certificate-content h2.text-green-600"
        );
        if (nameElement) nameElement.innerText = user.name;

        modal.classList.remove("hidden");
        modal.classList.add("flex");
      };
    </script>
    <div
      id="certificate-modal"
      class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center p-4 z-[100]"
    >
      <div
        id="certificate-content"
        class="bg-white rounded-xl shadow-2xl w-full max-w-4xl p-8 relative"
      >
        <button
          onclick="document.getElementById('certificate-modal').classList.add('hidden')"
          class="absolute top-4 right-4 text-gray-500 hover:text-gray-900 text-2xl"
        >
          <i class="fas fa-times-circle"></i>
        </button>

        <div
          class="text-center p-10 border-8 border-double border-blue-600 rounded-lg"
        >
          <p class="text-xl text-gray-500 mb-2">CERTIFICATE OF COMPLETION</p>
          <h1 class="text-5xl font-serif text-blue-800 mb-6 font-extrabold">
            EduPro
          </h1>
          <p class="text-3xl font-light italic mb-4">
            This certificate is proudly presented to
          </p>
          <h2 class="text-5xl font-semibold text-green-600 mb-6">
            Student Name
          </h2>
          <p class="text-xl mb-8">for successfully completing the course</p>
          <h3 class="text-4xl font-bold text-gray-800" id="cert-course-title">
            ...
          </h3>
          <div
            class="mt-8 text-lg text-gray-700 flex justify-center space-x-10"
          >
            <span>Date: <span class="font-bold" id="cert-date">...</span></span>
            <span
              >Score: <span class="font-bold" id="cert-score">...</span></span
            >
          </div>
          <p class="mt-8 text-sm text-gray-400">
            Instructor Signature: John Doe
          </p>
        </div>
      </div>
    </div>
  </body>
</html>
