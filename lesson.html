<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EduPro - Learning</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      /* small custom animation for the check badge */
      @keyframes check-pop {
        0% {
          transform: scale(0.6);
          opacity: 0;
        }
        60% {
          transform: scale(1.08);
          opacity: 1;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }
      .check-pop {
        animation: check-pop 360ms ease-out both;
      }
    </style>
  </head>
  <body
    class="bg-white text-gray-800 font-sans h-screen flex flex-col overflow-hidden"
  >
    <nav
      class="bg-gray-900 text-white h-16 flex items-center justify-between px-4 z-50 shadow-md flex-shrink-0"
    >
      <div class="flex items-center">
        <a href="index.html" class="font-bold text-lg mr-6 text-blue-400"
          >EduPro</a
        >
        <span
          class="text-gray-400 text-sm hidden md:inline"
          id="course-title-nav"
          >Course Name</span
        >
      </div>
      <a href="dashboard.html" class="text-sm hover:text-gray-300"
        ><i class="fas fa-times"></i> Exit</a
      >
    </nav>

    <div class="flex flex-1 overflow-hidden">
      <aside
        class="w-full md:w-80 bg-gray-50 border-r overflow-y-auto hidden md:block flex-shrink-0"
        id="sidebar"
        aria-label="Course content"
      ></aside>

      <main class="flex-1 overflow-y-auto p-4 md:p-8 bg-white" id="main">
        <div class="max-w-4xl mx-auto">
          <div
            id="video-area"
            class="bg-black w-full aspect-video flex items-center justify-center text-white rounded-lg shadow-lg mb-6 relative group cursor-pointer transition"
            role="button"
            aria-label="Video placeholder"
            tabindex="0"
          >
            <i
              class="fas fa-play-circle text-7xl opacity-80 group-hover:opacity-100 transition scale-100 group-hover:scale-110"
            ></i>
            <p class="absolute bottom-4 text-sm opacity-50">
              Video Placeholder (Lesson: <span id="video-lesson-title"></span>)
            </p>
          </div>

          <div id="lesson-details" class="mb-20"></div>
        </div>
      </main>
    </div>

    <!-- ======= courses-json-loader (insert BEFORE script.js) ======= -->
    <script>
      (function () {
        try {
          if (!localStorage.getItem("lmsCourses")) {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", "courses.json", false); // synchronous on purpose for a small project
            xhr.send(null);
            if (xhr.status >= 200 && xhr.status < 300) {
              localStorage.setItem("lmsCourses", xhr.responseText);
            } else {
              console.warn("courses.json load failed, status:", xhr.status);
            }
          }
        } catch (e) {
          console.error("Synchronous load of courses.json failed:", e);
        }

        try {
          window.coursesData = JSON.parse(
            localStorage.getItem("lmsCourses") || "[]"
          );
        } catch (e) {
          console.error("Failed to parse lmsCourses from localStorage:", e);
          window.coursesData = [];
        }
      })();
    </script>
    <!-- ================================================================ -->

    <script src="script.js"></script>
    <script>
      // Small helpers & defensive wrappers
      function escapeHtml(str) {
        if (typeof str !== "string") return str == null ? "" : String(str);
        return str
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      // Guard: ensure script.js helpers exist
      if (typeof getProgress !== "function") {
        console.error(
          "script.js helpers not available. Make sure script.js is loaded."
        );
      }

      // Ensure user is authenticated (script.js provides getCurrentUser)
      if (typeof getCurrentUser !== "function" || !getCurrentUser()) {
        alert("You must be logged in to view this page.");
        window.location.href = "login.html";
      }

      const params = new URLSearchParams(window.location.search);
      const cId = parseInt(params.get("courseId"), 10);
      const lId = parseInt(params.get("lessonId"), 10);

      // small live region for screen-reader updates
      const srLiveHtml = `<div id="sr-live" class="sr-only" aria-live="polite" aria-atomic="true"></div>`;
      if (!document.getElementById("sr-live")) {
        document.body.insertAdjacentHTML("beforeend", srLiveHtml);
      }

      // We'll keep references to current course/lesson globally for handlers
      let currentCourse = null;
      let currentLesson = null;

      function getSRLive() {
        return document.getElementById("sr-live");
      }

      function safeProgress(courseId) {
        if (typeof getProgress === "function") {
          try {
            const p = getProgress(courseId) || {};
            if (!Array.isArray(p.completedLessons)) p.completedLessons = [];
            return p;
          } catch (e) {
            console.warn("getProgress failed", e);
          }
        }
        return { completedLessons: [], quizScore: null };
      }

      function renderSidebar(progress) {
        const sidebar = document.getElementById("sidebar");
        if (!sidebar) return;
        const lessons = Array.isArray(currentCourse.lessons)
          ? currentCourse.lessons
          : [];
        const completed = Array.isArray(progress.completedLessons)
          ? progress.completedLessons
          : [];
        const currentLessonId = currentLesson && currentLesson.id;

        const header = `<div class="p-4 font-bold text-gray-700 border-b bg-gray-100">Course Content (${lessons.length} Lessons)</div>`;
        const items = lessons
          .map((l) => {
            const isDone = completed.includes(l.id);
            const isActive = l.id === currentLessonId;
            return `
                <a href="lesson.html?courseId=${cId}&lessonId=${l.id}"
                   class="block p-4 border-b text-sm transition ${
                     isActive
                       ? "bg-blue-50 text-blue-700 border-l-4 border-blue-600"
                       : "text-gray-600 hover:bg-gray-100"
                   }"
                   aria-current="${isActive ? "step" : "false"}">
                  <div class="flex items-center">
                    <i class="fas ${
                      isDone
                        ? "fa-check-circle text-green-500"
                        : "fa-circle text-gray-300"
                    } mr-2 text-xs" aria-hidden="true"></i>
                    <span class="${isActive ? "font-bold" : ""}">${escapeHtml(
              l.title
            )}</span>
                  </div>
                </a>
              `;
          })
          .join("");
        sidebar.innerHTML = header + items;
      }

      function renderLessonDetails() {
        if (!currentCourse || !currentLesson) return;
        const course = currentCourse;
        const lesson = currentLesson;
        const progress = safeProgress(cId);
        const totalIndex = Array.isArray(course.lessons)
          ? course.lessons.findIndex((l) => l.id === lesson.id) + 1
          : 1;

        const isLessonComplete = Array.isArray(progress.completedLessons)
          ? progress.completedLessons.includes(lesson.id)
          : false;

        // Determine button state
        const btnText = isLessonComplete ? "Completed" : "Mark Completed";
        const btnClass = isLessonComplete
          ? "bg-green-500 hover:bg-green-600 cursor-not-allowed"
          : "bg-green-600 hover:bg-green-700";

        const detailsNode = document.getElementById("lesson-details");
        if (!detailsNode) return;

        // render content (escape inserted values)
        detailsNode.innerHTML = `
          <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 border-b pb-4">
            <div>
              <h1 class="text-2xl font-bold text-gray-900">${escapeHtml(
                lesson.title
              )}</h1>
              <p class="text-gray-500 text-sm">Lesson ${totalIndex} of ${
          Array.isArray(course.lessons) ? course.lessons.length : 1
        }</p>
            </div>
            <button id="complete-btn" aria-pressed="${isLessonComplete}" ${
          isLessonComplete ? "disabled" : ""
        } class="mt-4 md:mt-0 text-white px-6 py-2 rounded shadow transition flex items-center ${btnClass}" >
              <i class="fas fa-check mr-2"></i> <span id="complete-btn-text">${btnText}</span>
            </button>
          </div>

          <article class="prose max-w-none text-gray-700 leading-relaxed">
            <p class="text-lg">${escapeHtml(lesson.content || "")}</p>
            <h3 class="font-bold text-xl mt-6 mb-2">Key Takeaways</h3>
            <ul class="list-disc pl-5 space-y-2">
              <li>Understanding the core concepts efficiently.</li>
              <li>Applying practical knowledge to real-world scenarios.</li>
              <li>Analyzing the results for better performance.</li>
            </ul>
          </article>

          <div id="quiz-link-area" class="mt-10 pt-6 border-t"></div>

          <div id="complete-anim-anchor" class="fixed top-6 right-6 z-50 pointer-events-none"></div>
        `;

        // attach button handler (safe attach)
        const btn = document.getElementById("complete-btn");
        if (btn) {
          btn.addEventListener("click", () => markComplete());
        }

        // update quiz link area
        updateNavigationButtons();
      }

      function updateNavigationButtons() {
        if (!currentCourse || !currentLesson) return;
        const course = currentCourse;
        const progress = safeProgress(cId);
        const lessons = Array.isArray(course.lessons) ? course.lessons : [];
        const lessonIndex = lessons.findIndex((l) => l.id === currentLesson.id);
        const isLastLesson = lessonIndex === lessons.length - 1;
        const allLessonsCompleted =
          Array.isArray(progress.completedLessons) &&
          progress.completedLessons.length === lessons.length;
        const linkArea = document.getElementById("quiz-link-area");
        if (!linkArea) return;

        if (
          allLessonsCompleted &&
          (progress.quizScore === null || progress.quizScore === undefined) &&
          Array.isArray(course.quiz) &&
          course.quiz.length > 0
        ) {
          linkArea.innerHTML = `
            <h3 class="text-2xl font-bold text-orange-600 mb-4">You're ready for the Final Quiz!</h3>
            <a href="quiz.html?courseId=${cId}" class="bg-orange-600 text-white px-8 py-3 rounded-lg font-bold hover:bg-orange-700 transition">
                Start Final Quiz &rarr;
            </a>
          `;
        } else if (
          allLessonsCompleted &&
          progress.quizScore !== null &&
          progress.quizScore !== undefined
        ) {
          linkArea.innerHTML = `
            <h3 class="text-2xl font-bold text-green-600 mb-4">Course Complete!</h3>
            <a href="dashboard.html" class="bg-blue-600 text-white px-8 py-3 rounded-lg font-bold hover:bg-blue-700 transition">
                View Dashboard & Certificate &rarr;
            </a>
          `;
        } else if (isLastLesson && !allLessonsCompleted) {
          linkArea.innerHTML = `<p class="text-lg text-gray-600">Complete all previous lessons to move to the quiz.</p>`;
        } else {
          linkArea.innerHTML = "";
        }
      }

      // Render everything (sidebar + main) from currentCourse/currentLesson state
      function renderAll() {
        if (!currentCourse || !currentLesson) return;
        const progress = safeProgress(cId);
        const titleNode = document.getElementById("course-title-nav");
        if (titleNode) titleNode.innerText = currentCourse.title || "Course";
        const videoTitle = document.getElementById("video-lesson-title");
        if (videoTitle) videoTitle.innerText = currentLesson.title || "";
        renderSidebar(progress);
        renderLessonDetails();
      }

      // Mark the lesson as completed, update UI instantly, animate, and optionally navigate
      function markComplete() {
        const btn = document.getElementById("complete-btn");
        if (!btn || btn.disabled) return;

        // 1) Try to mark complete in storage
        let ok = false;
        if (typeof completeLesson === "function") {
          try {
            ok = completeLesson(cId, lId);
          } catch (e) {
            console.warn("completeLesson threw:", e);
            ok = false;
          }
        } else {
          console.warn("completeLesson not defined");
        }

        if (!ok) {
          // If it returned false, it may already be complete; just refresh UI
          const sr = getSRLive();
          if (sr) sr.innerText = "Lesson already marked completed.";
          renderAll();
          return;
        }

        // 2) Update UI: button + animate check
        btn.disabled = true;
        const btnTextEl = document.getElementById("complete-btn-text");
        if (btnTextEl) btnTextEl.innerText = "Completed";
        btn.classList.remove("bg-green-600", "hover:bg-green-700");
        btn.classList.add(
          "bg-green-500",
          "hover:bg-green-600",
          "cursor-not-allowed"
        );

        // small floating check animation
        const anchor = document.getElementById("complete-anim-anchor");
        if (anchor) {
          const el = document.createElement("div");
          el.className = "bg-white rounded-full p-3 shadow-lg check-pop";
          el.innerHTML = `<i class="fas fa-check-circle text-green-500 text-2xl"></i>`;
          anchor.appendChild(el);
          setTimeout(() => {
            try {
              el.style.transition = "opacity 350ms ease";
              el.style.opacity = "0";
              setTimeout(() => {
                if (el && el.parentNode === anchor) anchor.removeChild(el);
              }, 380);
            } catch (e) {
              // ignore
            }
          }, 700);
        }

        // 3) Save last visited as current lesson (keeps dashboard updated)
        try {
          if (typeof saveLastVisited === "function") saveLastVisited(cId, lId);
        } catch (e) {
          console.warn("saveLastVisited failed:", e);
        }

        // 4) Re-render sidebar + buttons to reflect new progress
        renderAll();

        // 5) Announce to screen readers and any listeners
        const sr = getSRLive();
        if (sr) sr.innerText = `Marked "${currentLesson.title}" as completed.`;

        // Dispatch a custom event so other components/pages can react (e.g., header/dashboard widgets)
        window.dispatchEvent(
          new CustomEvent("progressUpdated", {
            detail: { courseId: cId, lessonId: lId },
          })
        );

        // 6) Navigation: offer to go to next lesson (but only if not last)
        const courseObj = currentCourse;
        const lessons = Array.isArray(courseObj.lessons)
          ? courseObj.lessons
          : [];
        const lessonIndex = lessons.findIndex((l) => l.id === lId);
        const isLast = lessonIndex === lessons.length - 1;

        if (!isLast) {
          const nextId = lessons[lessonIndex + 1]?.id;
          if (nextId && confirm("Lesson Completed! Go to the next lesson?")) {
            // replace state to avoid piling history
            window.location.replace(
              `lesson.html?courseId=${cId}&lessonId=${nextId}`
            );
            return;
          }
          // else: stay on same page, UI is already updated
        } else {
          // last lesson: if all lessons complete, prompt to take quiz
          const progressNow = safeProgress(cId);
          if (
            Array.isArray(progressNow.completedLessons) &&
            progressNow.completedLessons.length === lessons.length
          ) {
            alert(
              "Congratulations! All lessons are complete. Proceed to the Final Quiz."
            );
            window.location.replace(`quiz.html?courseId=${cId}`);
            return;
          }
        }
      }

      // initial boot: check params and render
      (function init() {
        // validate params
        if (!cId || !lId || isNaN(cId) || isNaN(lId)) {
          alert("Error: Course or Lesson not found.");
          window.location.href = "courses.html";
          return;
        }

        // find course
        currentCourse = (window.coursesData || []).find((c) => c.id === cId);
        if (!currentCourse) {
          alert("Error: Course not found.");
          window.location.href = "courses.html";
          return;
        }

        // ensure lessons array exists
        if (
          !Array.isArray(currentCourse.lessons) ||
          currentCourse.lessons.length === 0
        ) {
          alert("This course has no lessons yet.");
          window.location.href = `course-detail.html?id=${cId}`;
          return;
        }

        currentLesson = currentCourse.lessons.find((l) => l.id === lId);
        if (!currentLesson) {
          alert("Error: Lesson not found.");
          window.location.href = `course-detail.html?id=${cId}`;
          return;
        }

        // LOCK CHECK: prevent jumping ahead
        const progress = safeProgress(cId);
        const completed = Array.isArray(progress.completedLessons)
          ? progress.completedLessons
          : [];
        const lessonIndex = currentCourse.lessons.findIndex(
          (l) => l.id === lId
        );
        // allow visiting the next lesson (lessonIndex === completed.length) or any completed ones
        if (lessonIndex > completed.length) {
          alert("Please complete previous lessons first.");
          window.location.href = `course-detail.html?id=${cId}`;
          return;
        }

        // Save last visited (defensive), so dashboard shows it
        try {
          if (typeof saveLastVisited === "function") saveLastVisited(cId, lId);
        } catch (e) {
          /* ignore */
        }

        // initial render
        renderAll();

        // keyboard accessible play toggle on video-area
        const videoArea = document.getElementById("video-area");
        if (videoArea) {
          videoArea.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              // optional: open a modal with actual video later
              alert("Video placeholder — implement video player here.");
            }
          });
          videoArea.addEventListener("click", () => {
            alert("Video placeholder — implement video player here.");
          });
        }
      })();
    </script>
  </body>
</html>
